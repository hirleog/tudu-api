name: Deploy Tudu API (Production)

on:
  push:
    branches: ['master', 'main']
    paths:
      - 'src/**' # Monitora mudanças nos arquivos fonte
      - 'package.json' # Se houver mudanças nas dependências
      - 'nest-cli.json' # Configurações do NestJS

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      # Configuração SSH
      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.API_TUDU_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo -e "Host 89.116.73.70\n  StrictHostKeyChecking yes" > ~/.ssh/config
          ssh-keyscan 89.116.73.70 >> ~/.ssh/known_hosts

      # Instalação e Build
      - name: Instalar e Buildar
        run: |
          npm ci
          npm run build
          echo "✅ Build concluído. Arquivos em dist/:"
          ls -la dist/

      # Deploy
      - name: Sincronizar arquivos
        run: |
          rsync -avz \
            --progress \
            --delete \
            --exclude='node_modules' \
            --exclude='.env' \
            -e "ssh -i ~/.ssh/deploy_key" \
            ./dist/ \
            ./package.json \
            deployer@89.116.73.70:/var/www/tudu-api/

      # Configuração do PM2
      - name: Configurar Serviço
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 89.116.73.70
          username: deployer
          key: ${{ secrets.API_TUDU_SSH_KEY }}
          script: |
            echo "=== Preparando ambiente ==="
            cd /var/www/tudu-api
            npm ci --production

            echo "=== Configurando PM2 ==="
            cat <<EOF > ecosystem.config.js
            module.exports = {
              apps: [{
                name: "tudu-api",
                script: "./main.js",
                cwd: "/var/www/tudu-api",
                env: {
                  NODE_ENV: "production",
                  PORT: 3000
                },
                error_file: "/var/log/tudu-api/error.log",
                out_file: "/var/log/tudu-api/out.log"
              }]
            }
            EOF

            echo "=== Reiniciando API ==="
            pm2 delete tudu-api --silent || true
            pm2 start ecosystem.config.js
            pm2 save
            pm2 startup

            echo "=== Status ==="
            pm2 list
